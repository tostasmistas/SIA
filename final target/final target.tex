\documentclass[11pt]{article}

\usepackage[portuguese]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{float}
\usepackage{subfig}
\usepackage{fixltx2e}
\usepackage[bottom]{footmisc}
\usepackage{color}
\usepackage{xargs}                      % Use more than one optional parameter in a new commands
\usepackage[pdftex,dvipsnames]{xcolor}  % Coloured text etc.
\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}
\newcommandx{\unsure}[2][1=]{\todo[linecolor=red,backgroundcolor=red!25,bordercolor=red,#1]{#2}}
\newcommandx{\change}[2][1=]{\todo[linecolor=blue,backgroundcolor=blue!25,bordercolor=blue,#1]{#2}}
\newcommandx{\info}[2][1=]{\todo[linecolor=OliveGreen,backgroundcolor=OliveGreen!25,bordercolor=OliveGreen,#1]{#2}}
\newcommandx{\improvement}[2][1=]{\todo[linecolor=Plum,backgroundcolor=Plum!25,bordercolor=Plum,#1]{#2}}
\newcommandx{\thiswillnotshow}[2][1=]{\todo[disable,#1]{#2}}
\usepackage[font=footnotesize]{caption}

\numberwithin{equation}{section}

\linespread{1.3}
\usepackage{indentfirst}
\usepackage[top=2cm, bottom=2cm, right=2.25cm, left=2.25cm]{geometry}
\addto\captionsportuguese{\renewcommand{\contentsname}{Índice}}

\begin{document}

\begin{titlepage}
\begin{center}

\hfill \break
\hfill \break

\includegraphics[width=0.3\textwidth]{./logo}~\\[1cm]

\textsc{\LARGE Instituto Superior Técnico}\\[0.25cm]
\textsc{\Large Mestrado Integrado em Engenharia Electrotécnica e de Computadores}\\[1.8cm]
\textsc{\huge Sistemas Integrados Analógicos}\\[0.25cm]

{\huge \bfseries \textit{Design} de um Amplificador \\[1cm]}

\begin{tabular}{ l l }
João Bernardo Sequeira de Sá & \hspace{2mm} n.º 68254 \\
Maria Margarida Dias dos Reis & \hspace{2mm} n.º 73099 \\
Nuno Miguel Rodrigues Machado & \hspace{2mm} n.º 74236
\end{tabular}

\vfill

{\large Lisboa, 31 de Maio de 2015} 

\end{center}
\end{titlepage}

\pagenumbering{gobble}
\clearpage

\tableofcontents
\pagebreak

\clearpage
\pagenumbering{arabic}

\section{Introdução}

Pretende-se projectar um amplificador \textit{folded cascode} CMOS OTA de dois andares de acordo com as especificações da seguinte tabela.

\begin{table}[H]
	\centering
	\caption{Características do amplificador a projectar.}
	\vspace{-1.5mm}
	\includegraphics[keepaspectratio=true, scale=0.45]{teoricas/tabela1}
	\label{tab:tab1}
\end{table}

O circuito de ponto de partida para a realização do projecto é apresentado de seguida.

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.50]{teoricas/circuito1}
	\vspace{-0.5em}
	\caption{Circuito do amplificador a projectar.}
	\vspace{-0.8em}
\end{figure} 

\section{Adenda ao \textit{Middle Target}}

Esta secção foi acrescentada ao relatório final no intuito de corrigir os resultados obtidos e apresentados no relatório anterior, o do \textit{middle target}. Como referenciado, pretende-se projectar um amplificador \textit{folded cascode} CMOS OTA de dois andares de acordo com as especificações da Tabela \ref{tab:tab1}.

\subsection{Detecção dos erros} 

Foram identificados vários erros no relatório intermédio que comprometem os resultados apresentados anteriormente. A primeira correcção foi referente ao \textit{schematic} do \textit{testbench} que permite simular o circuito em testes de resposta AC. Foi colocado um \textit{switch} que simula a bobine - provoca um circuito aberto para um regime AC e curto-circuito para um regime DC. Foi também alterada a amplitude do sinal de entrada de 3.3 V para 1.6 V, sendo que esta alteração garante que os transístores não saem da saturação. De seguida pode-se comparar o novo \textit{testbench} com o anterior.

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.60]{exps/TBac}
	\vspace{-0.5em}
	\caption{\textit{Schematic} do \textit{testbench} anterior que permite simular o circuito em testes de resposta AC.}
	\vspace{-0.8em}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.50]{exps/testebenchantigo}
	\vspace{-0.5em}
	\caption{\textit{Schematic} do novo \textit{testbench} que permite simular o circuito em testes da \textit{slew-rate} e de resposta transiente, DC e AC.}
	\vspace{-0.8em}
\end{figure} 

Outro erro identificado é referente ao cálculo da \textit{slew-rate}. No relatório intermédio, o resultado da \textit{slew-rate} era relativo só ao flanco de descida, sendo necessário demonstrar para os dois flancos - subida (equação 2.1) e descida (equação 1.2). 

\vspace{-3mm}
\begin{equation}
	\text{slewRate} (\text{VT("/OUT")} \:\: 1 \:\: \text{nil} \:\: 2 \:\: \text{nil} \:\: 10 \:\: 90 \:\: \text{nil} \:\: "\text{time}")
\end{equation}

\vspace{-3mm}
\begin{equation}
	\text{slewRate} (\text{VT("/OUT")} \:\: 2 \:\: \text{nil} \:\: 1 \:\: \text{nil} \:\: 10 \:\: 90 \:\: \text{nil} \:\: "\text{time}")
\end{equation}

\todo{falar destas expressoes - explicar das regioes de funcionamento dos transistores}

\todo{ha mais erros?}

\subsection{Correcção do dimensionamento}

\todo{explicar isto}

\info{nao esquecer que o racio de m1 e m2 mudou face ao da entrega intermedia, explciar porque}

Assim, o circuito final relativamente à entrega intermédia é:

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.42]{teoricas/circuitoantesdadiv}
	\vspace{-0.5em}
	\caption{Circuito final da entrega intermédia.}
	\vspace{-0.8em}
	\label{fig:finalint}
\end{figure} 

\begin{table}[H]
	\centering
	\caption{Dimensões dos transístores que constituem o amplificador.}
	\vspace{-1.5mm}
	\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/dimensoes1}
\end{table}

\subsection{Demonstração de resultados} 

Nesta secção apresenta-se os resultados do dimensionamento do relatório intermédio e do novo dimensionamento anteriormente referido, para simulações de Monte Carlo e de \textit{corners}.

\subsubsection{Resultados do dimensionamento inicial} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/MonteCarlo_50pt_Antigo}
	\vspace{-0.5em}
	\caption{Simulação de Monte Carlo para 50 pontos.}
	\vspace{-0.8em}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/MonteCarlo_3pt_Antigo}
	\vspace{-0.5em}
	\caption{Resultados obtidos para as 3 primeiras simulações de Monte Carlo.}
	\vspace{-0.8em}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/Corners_Antigo}
	\vspace{-0.5em}
	\caption{Simulação por \textit{corners}.}
	\vspace{-0.8em}
\end{figure} 

\subsubsection{Resultados do dimensionamento corrigido} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/MonteCarlo_50pt_Novo}
	\vspace{-0.5em}
	\caption{Simulação de Monte Carlo para 50 pontos.}
	\vspace{-0.8em}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/MonteCarlo_3pt_Novo}
	\vspace{-0.5em}
	\caption{Resultados obtidos para as 3 primeiras simulações de Monte Carlo.}
	\vspace{-0.8em}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.65]{exps/Corners_Novo_semDiv}
	\vspace{-0.5em}
	\caption{Simulação por \textit{corners}.}
	\vspace{-0.8em}
\end{figure} 

\todo{comentar diferenças obtidas}

\section{Projecção do \textit{Layout}}

\subsection{Multiplicidade e \textit{Fingers}}

Para projectar o \textit{layout} do circuito da Figura \ref{fig:finalint} optou-se por dividir os transístores de grandes dimensões com recurso a duas técnicas - multiplicidade e \textit{fingers}. A técnica de \textit{fingers} corresponde a um arranjo específico do transístor com $n$ \textit{gate fingers} em que as difusões da \textit{source} e do \textit{drain} são partilhadas. Se se tiver $n$ \textit{fingers} haverá então $n+1$ difusões. A multiplicidade é quando se faz uma ligação em paralelo de múltiplos dispositivos MOS, sendo que o agregado deles corresponde a um só transístor. 

Do ponto de vista da definição correspondem ao mesmo, mas são de facto duas maneiras diferentes de pensar na paralelização de transístores. Com o recurso a \textit{fingers} tem-se uma única célula com o transístor completo com todos os \textit{fingers}, útil para quando se quer uma célula mais compacta, enquanto na multiplicidade tem-se tantos transístores quanto a multiplicidade indicar. De facto, é possível conjugar as duas técnicas, ou seja, cada dispositivo MOS da multiplicidade pode ser feito com vários \textit{fingers}.

Para o trabalho em causa optou-se por usar as duas técnicas teoricamente idênticas para adquirir mais experiência e para verificar as diferenças que têm ao ível de implementação prática no Cadence.

\todo{criterio para as multiplicidades e fingers do transistores}

Assim, na tabela seguinte encontra-se uma descrição de como são constituídos os vários transístores do circuito.

\begin{table}[H]
	\centering
	\caption{Dimensões e características dos transístores do amplificador.}
	\vspace{-1.5mm}
	\includegraphics[keepaspectratio=true, scale=0.30]{teoricas/dimensoes2}
\end{table}

\subsection{Disposição dos transístores}

Depois de se definir como estão estruturados os vários transístores é importante definir como se encontram dispostos no \textit{layout}. A topologia básica que foi utilizada é a de \textit{common centroid}. Através desta técnica consegue-se garantir um melhor \textit{matching} entre dois transístores iguais e em que se pretende um comportamento semelhante. De facto, o \textit{common centroid} é utilizado para se garantir que, e.g., um amplificador diferencial tenha um sinal de modo comum próximo de 0 e, como tal, um CMRR maior.

Para o circuito em causa foram definidos 4 blocos principais sobre os quais se definiu uma estrutura \textit{common centroid}:

\vspace{-2mm}

\begin{itemize}
	\item espelho de corrente básico que é polarizado em corrente com $I_{BIAS}$ (equivalente ao Bloco 1 da Figura 1) - estrutura \textit{common centroid} \#1;
	\vspace{-2mm}
	\item transístores do par diferencial (Bloco 2 da Figura 1) - estrutura \textit{common centroid} \#2;
	\vspace{-2mm}
	\item espelho de corrente cascode básico do tipo PMOS (Bloco 3 da Figura 1) - estrutura \textit{common centroid} \#3;
	\vspace{-2mm}
	\item transístores do tipo NMOS - estrutura \textit{common centroid} \#4;.
\end{itemize}

A escolha destes blocos foi feita com base no \textit{mismatch}. É essencial que entre os transístores do par diferencial não haja diferenças de comportamento, pois se houver o circuito fica desequilibrado. Os dois espelhos de corrente existentes também não devem ter \textit{mismatch}, pois pretende-se um espelhamento correcto. \todo{e os transistores NMOS?}

De seguida apresenta-se as várias estruturas \textit{common centroid} definidas:

\begin{figure}[H]
	\centering
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/espelhodecorrente}}
	\hspace{8mm}
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/pardiferencial}}
	\linebreak
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/espelhodecorrenteamp}}
	\hspace{40mm}
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/nmos}}
	\vspace{-0.8em}
	\caption{Estrutura \textit{common centroid} \#1 (a), \#2 (b), \#3 (c) e \#4 (d).}
	\vspace{-0.8em}
	\label{fig:common centroid}
\end{figure}

Nas figuras anteriores verifica-se a existências de transístores representados pela letra D - transístores \textit{dummies}. Este tipo de transístores serve para se garantir que os restantes transístores têm a mesma vizinhança, ou seja, que à sua volta vêem o mesmo. Veja-se o seguinte exemplo em que se consideram dois transístores - 1 e 2. O transístor 1 está definido com uma multiplicidade de 1 e o transístor 2 com uma multiplicidade de 8. Na figura seguinte encontra-se um exemplo de estrutura \textit{common centroid} para esse caso. 

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/dummy1}
	\vspace{-0.5em}
	\caption{Exemplo de estrutura \textit{common centroid} com dois transístores.}
	\vspace{-0.8em}
\end{figure} 

O transístor 1 tem como vizinhança 4 transístores - para cima, para baixo, para a esquerda e para a direita. No entanto, qualquer transístor 2 tem uma ``falha'' naquilo que vê, pois não tem ``vizinhos'' nalgumas direcções. Assim, para se resolver este problema colocam-se transístores \textit{dummies} nos sítios onde há ``falhas''.

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/dummy2}
	\vspace{-0.5em}
	\caption{Exemplo de estrutura \textit{common centroid} com dois transístores e também transístores \textit{dummies}.}
	\vspace{-0.8em}
\end{figure}

De facto, os transístores \textit{dummies} não necessitam de ter as mesmas dimensões que os restantes e o circuito da figura anterior pode ser definido sa seguinte maneira.

\begin{figure}[H]
	\centering
	\includegraphics[keepaspectratio=true, scale=0.35]{teoricas/dummy3}
	\vspace{-0.5em}
	\caption{Exemplo de estrutura \textit{common centroid} com dois transístores e também transístores \textit{dummies} de dimensões menores.}
	\vspace{-0.8em}
\end{figure}

Relembrando as estruturas da Figura \ref{fig:common centroid}, verifica-se que a estruturas \#1 e \#3 têm \textit{dummies}. \todo{explicar porque têm, e porque as outra nao têm}

\subsection{Ligações internas dos blocos}

Uma vez definidos como estão estruturados os transístores e como estão dispostos efecutam-se as ligações internas dos 4 blocos da Figura \ref{fig:common centroid}.

Existem várias regras para construir um \textit{layout}, sendo que uma delas impõe um espaço mínimo para separar as diferentes máscaras. Para evitar isto, recorre-se a uma opção existente no Cadence que notifica o utilizador quando este não cumpre as margens mínimas. 

As ligações entre \textit{gates} de transístores que estejam próximos são feitas a partir da camada condutora \texttt{poly}. Porém, se os transístores estiverem afastados é preferível efectuar a ligação com recurso a \texttt{Metal 1} e a contactos do tipo \texttt{P1\_C}, que efectuam a ligação entre \texttt{poly} e \texttt{Metal 1}. Esta solução é preferível para esses casos pois a \texttt{poly} tem uma resistividade elevada e colocar demasiado dessa camada faz aumentar a resistividade geral do circuito. De facto, na tabela seguinte apresenta-se a resistividade das diversas máscaras existentes no fabrico e verifica-se que a \texttt{poly} (\texttt{poly 1}) tem uma resistividade bem superior face a camadas como \texttt{Metal 1} e \texttt{Metal 2}. Verifica-se também que a resistividade de um contacto do tipo \texttt{P1\_C} é elevada, mas que compensa, uma vez que para efectuar uma ligação correcta entre duas \textit{gates} bastaria colocar no máximo 2 contactos.

\begin{table}[H]
	\centering
	\caption{Resistividade das diversas máscaras de fabrico (a) e resistividade dos diversos tipos de contactos (b).}
	\vspace{-1.5mm}
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.20]{teoricas/resistance}}
	\hspace{8mm}
	\subfloat[]{\includegraphics[keepaspectratio=true, scale=0.27]{teoricas/resistanceC}}
	\vspace{-0.8em}
\end{table}

Tomou-se a decisão de, sempre que possível, efectuar as ligações com \texttt{Metal 1} na horizontal e com \texttt{Metal 2} na vertical. Procura-se aplicar esta \textit{rule of thumb} sempre que possível, sendo que apenas não é cumprida quando se verifica que acaba por tornar mais difícil o \textit{design} do \textit{layout} ou que conduz a uma área maior porque é necessário ajustar o espaçamento entre transístores para acomodar uma ligação em \texttt{Metal 1} ou \texttt{Metal 2} consoante o caso.

Para ligar \texttt{Metal 1} a \texttt{Metal 2} é usada uma via. De referir que, optou-se também, sempre que possível, por colocar vias e contactos duplos, para que houvesse um de \textit{backup}. À semelhança do que se referiu anteriormente, isto é feito quando não dificulta o \textit{design} do \textit{layout}.

\subsection{Ligações externas entre os blocos}

\pagebreak

\section{Conclusões}

\end{document}